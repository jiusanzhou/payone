(()=>{var K=Object.create;var f=Object.defineProperty;var X=Object.getOwnPropertyDescriptor;var Y=Object.getOwnPropertyNames;var Z=Object.getPrototypeOf,z=Object.prototype.hasOwnProperty;var ee=t=>f(t,"__esModule",{value:!0});var d=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports);var te=(t,e,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of Y(e))!z.call(t,o)&&o!=="default"&&f(t,o,{get:()=>e[o],enumerable:!(s=X(e,o))||s.enumerable});return t},se=t=>te(ee(f(t!=null?K(Z(t)):{},"default",t&&t.__esModule&&"default"in t?{get:()=>t.default,enumerable:!0}:{value:t,enumerable:!0})),t);var R=d((Oe,P)=>{function re({host:t=".*",path:e=".*",excludePath:s=null,method:o=[".*"],handler:r,protocol:n=".*",handlerName:a,headers:i={},data:l}){let h=[],m=[],H=t.replace(/(:([^.]+))/g,(V,F,c)=>(h.push(c),"([^.]+)")),M=e.replace(/(:([^/]+))/g,(V,F,c)=>c.slice(-1)==="*"?(m.push(c.slice(0,c.length-1)),"(.*)"):(m.push(c),"([^/]*)")),G=new RegExp(`^${H}$`,"i"),J=new RegExp(`^${M}$`,"i"),B=s?new RegExp(`^${s}$`,"i"):null,Q=new RegExp(`^${o.join("|")}$`,"i"),W=new RegExp(`^${n}$`,"i");return{hostVariables:h,pathVariables:m,host:t,hostRegex:G,path:e,pathRegex:J,excludePath:s,excludePathRegex:B,method:o,methodRegex:Q,protocol:n,protocolRegex:W,handler:r,handlerName:a,headers:i,data:l}}function C(t){return[...t].reduce((e,s)=>{let o={};return o[s[0]]=s[1],{...e,...o}},{})}async function ne(t,e=1024*1024){let s=[],o=t.getReader(),r=new TextDecoder,n=0;for(;e&&n<e;){let{done:i,value:l}=await o.read();if(i)break;n+=l.byteLength,s.push(r.decode(l))}let a=s.join("");return e?a.substring(0,e):a}function ae(t){let e=new URL(t.url),s=C(e.searchParams),o=C(t.headers);o.host&&(e.hostname=o.host);let r,n;async function a(i){if(n>=i)return r.substring(0,i);let l=t.clone();return r=await ne(l.body,i),r}return{body:t.body,headers:o,host:e.host,hostname:e.hostname,href:e.href,json:async i=>JSON.parse(await a(i)),method:t.method,origin:`${e.protocol}//${e.host}`,path:e.pathname,protocol:e.protocol.slice(0,-1),query:s,querystring:e.search.slice(1),search:e.search,text:async i=>t.headers.get("content-type")==="application/x-www-form-urlencoded"?decodeURIComponent(await a(i)):a(i)}}P.exports={parseRoute:re,parseRequest:ae}});var U=d((Ce,j)=>{function ie(t,e){let s={},o=e.hostRegex.exec(t.host);e.hostVariables.forEach((n,a)=>{s[n]=o[a+1]});let r=e.pathRegex.exec(t.path);return e.pathVariables.forEach((n,a)=>{s[n]=r[a+1]}),s}function le(t,e){let s=!0;return Object.keys(t.headers).forEach(o=>{e.headers[o]!==t.headers[o]&&(s=!1)}),s}function he(t,e){return t.protocolRegex.test(e.protocol)}function ue(t,e){return t.methodRegex.test(e.method)&&t.hostRegex.test(e.host)&&t.pathRegex.test(e.path)&&le(t,e)&&he(t,e)&&(!t.excludePath||!t.excludePathRegex.test(e.path))}function ce(t,e){return e.filter(s=>s.hostRegex.test(t.host)&&s.pathRegex.test(t.path))}async function b(t,e){let[s,...o]=e;if(!s)return new Response("NOT_FOUND",{status:404});if(!ue(s,t.request))return b(t,o);t.state.handlers=t.state.handlers||[],t.state.handlers.push(s.handlerName||s.handler.name),t.params=ie(t.request,s);try{return s.handler(t,async r=>b(r,o))}catch(r){throw r.route=s.handler.name,r}}j.exports={matchRoutePaths:ce,recurseRoutes:b}});var v=d((Pe,A)=>{A.exports={methods:{DELETE:"DELETE",GET:"GET",HEAD:"HEAD",OPTIONS:"OPTIONS",PATCH:"PATCH",POST:"POST"},statusMessages:{404:"Not found",429:"Rate limited"}}});var _=d((je,k)=>{var pe=R();k.exports=class S{constructor(e){this.request=pe.parseRequest(e.request),this.event=e,this.state={},this.cloned=!1,this.response={headers:{}},this.body="",this.status=404,this.query=this.request.query}header(e){return this.request.headers[e]}set(e,s){this.response.headers[e]=s}clone(){let e=new S(this.event);return e.cloned=!0,e}}});var D=d((Ae,I)=>{var u=R(),N=U(),p=v(),de=_();I.exports=class{constructor(){this.routes=[]}get(e,s){let o=u.parseRoute({method:[p.methods.GET,p.methods.HEAD],path:e,handler:s});this.routes.push(o)}options(e,s){let o=u.parseRoute({method:[p.methods.OPTIONS],path:e,handler:s});this.routes.push(o)}post(e,s){let o=u.parseRoute({method:[p.methods.POST],path:e,handler:s});this.routes.push(o)}patch(e,s){let o=u.parseRoute({method:[p.methods.PATCH],path:e,handler:s});this.routes.push(o)}del(e,s){let o=u.parseRoute({method:[p.methods.DELETE],path:e,handler:s});this.routes.push(o)}allowMethods(){this.options(".*",e=>{let s=N.matchRoutePaths(e.request,this.routes).filter(r=>!r.middleware),o={};s.forEach(r=>{r.method.forEach(n=>{o[n]=!0})}),e.status=204,e.set("Access-Control-Allow-Method",Object.keys(o).join(", "))})}use(e){let s=u.parseRoute({handler:e,middleware:!0});this.routes.push(s)}add({host:e,path:s,excludePath:o,method:r,handlerName:n,headers:a,protocol:i},l){let h=u.parseRoute({method:r,host:e,path:s,excludePath:o,handler:l,headers:a,handlerName:n,protocol:i});this.routes.push(h)}async resolve(e){let s=new de(e);try{return await N.recurseRoutes(s,this.routes),new Response(s.body,{status:s.status,headers:s.response.headers})}catch(o){return new Response(o.message,{status:500})}}}});var x=[{name:"alipay",title:"\u652F\u4ED8\u5B9D",ua:"Alipay",logo:"/assets/img/alipay-logo.svg",logoFull:"/assets/img/alipay-logo-full.svg",color:"#00a1e9",tip:"\u5982\u672A\u8DF3\u8F6C\u8BF7\u4ECE\u6D4F\u89C8\u5668\u4E2D\u6253\u5F00",url:"https://qr.alipay.com/",redirect:!0},{name:"wechat",title:"\u5FAE\u4FE1\u652F\u4ED8",ua:"MicroMessenger",logo:"/assets/img/wechat-logo.svg",color:"#54bc6e",tip:"\u261D\uFE0F \u957F\u6309\u5E76\u8BC6\u522B\u4E8C\u7EF4\u7801",url:"wxp://"},{name:"qq",title:"QQ\u94B1\u5305",ua:"QQ/",logo:"/assets/img/qq-logo.svg",color:"#faae09",disable:!0,url:"https://i.qianbao.qq.com/wallet/sqrcode.htm?m=tenpay&a=1&"},{name:"unionpay",title:"\u4E91\u95EA\u4ED8",ua:"UnionPay/",color:"#e32b25",logo:"/assets/img/unionpay-logo.png",disable:!0,url:"https://qr.95516.com/00010000/"}];var E=async(t,e={})=>{let{timeout:s=5e3}=e,o=new AbortController,r=setTimeout(()=>o.abort(),s),n=await fetch(t,{...e,signal:o.signal});return clearTimeout(r),n};var T=class{put(e,s){throw new Error("unimplement")}get(e){throw new Error("unimplement")}},w=class extends T{constructor({host:e,basicUrl:s,keyPrefix:o}={}){super();this._host=e||"https://git.io",this._basicUrl=s||"https://jiusanzhou.github.io/payone/s",this._keyPrefix=o||"payone-",this.fetch=E}_buildTargetUrl(e){let s=Object.keys(e).map(o=>`${encodeURIComponent(o)}=${encodeURIComponent(e[o])}`).join("&");return`${this._basicUrl}${this._basicUrl.indexOf("?")>0?"&":"?"}${s}`}async put(e,s){if(!s||Object.keys(s).length===0)throw new Error("empty data object");let o=this._buildTargetUrl(s);return console.log("[GitioStore] put",e,o),this.fetch(this._host,{method:"POST",body:`code=${this._keyPrefix}${e}&url=${encodeURIComponent(o)}`,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(async r=>{if(r.ok)return!0;throw console.log("[GitioStore] response",r.statusText),new Error(await r.text())})}async get(e){return this.fetch(`${this._host}/${this._keyPrefix}${e}`,{method:"HEAD"}).then(s=>{let o=s.url;console.log("[GitioStore] get",e,o);let r={};return new URL(o).searchParams.forEach((n,a)=>r[a]=n),r})}};var y=class{config={};_regexua;constructor(e){this.config=e,this.name=e.name,this._regexua=new RegExp(this.config.ua)}match(e){return this.config.ua===e?!0:this._regexua===null?!1:this._regexua.test(e)}gen(e){let s=this.config.url;return s.indexOf("{}")<0?s+e.code:s.replace("{}",e.code)}},q=class{version="v0.0.1";qs=[];constructor({basicUrl:e}={}){this.basicUrl=e||"https://labs.zoe.im/payone/s/",this.qs=x.map(s=>new y(s)),this.store=new w}getItem=async(e,s="")=>{if(!e)return[null,null,null,"code cannot be empty"];let o=null;try{o=await this.store.get(e)}catch(l){return console.log(`[payone] get ${e} failed: ${l.message}`),[null,null,null,l.message]}let r=null,n=s;console.log("[payone] match with the user-agent",n);for(let l=0;l<this.qs.length&&(r=this.qs[l],!r.match(n));l++)r=null;r&&console.log("[payone] match the channel",r.name);let a,i;if(r&&(i=r.name),r&&r.config.redirect&&o[i])a=r.gen({code:o[i]});else{let l=Object.keys(o).map(h=>`${encodeURIComponent(h)}=${encodeURIComponent(o[h])}`).join("&");a=`${this.basicUrl}${this.basicUrl.indexOf("?")>0?"&":"?"}${l}`}return[i,a,o,null]};createItem=async(e,s={})=>{if(!e)return[!1,"code can't be empty"];console.log(`[payone] create ${e}: ${JSON.stringify(s)}`);try{await this.store.put(e,s)}catch(o){return console.log("[payone] create error:",o.message),[!1,o.message]}return[!0,null]};listSupported=()=>this.qs.map(e=>e.config)};var O=q;var L=se(D()),$=new O,g=new L.default;g.get("/api/s/:code",async t=>{let e=t.params.code,[s,o,r,n]=await $.getItem(e,t.request.headers["user-agent"]);if(t.response.headers["Access-Control-Allow-Origin"]="*",t.query.type==="json"){if(n){t.body=JSON.stringify({error:n}),t.status=200,t.response.headers["Content-Type"]="application/json";return}t.body=JSON.stringify({key:e,channel:s,url:o,channels:r}),t.status=200,t.response.headers["Content-Type"]="application/json";return}if(n){t.body=`system error: ${n}`,t.status=500;return}t.status=302,t.response.headers.Location=o});g.post("/api/s/:code",async t=>{let e=await t.request.json(),s=t.params.code,[o,r]=await $.createItem(s,e),n={key:s,data:e,success:o};o||(n.error=r),t.body=JSON.stringify(n),t.response.headers["Content-Type"]="application/json",t.response.headers["Access-Control-Allow-Origin"]="*",t.status=200});g.get("/api/supports",async t=>{t.body=JSON.stringify($.listSupported()),t.response.headers["Content-Type"]="application/json",t.response.headers["Access-Control-Allow-Origin"]="*",t.status=200});g.allowMethods();addEventListener("fetch",t=>t.respondWith(g.resolve(t)));})();
